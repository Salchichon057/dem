// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String?
  nombre       String?
  apellidos    String?
  telefono     String?
  role         Role     @default(USER)
  rol          String?  // Para compatibilidad con el frontend
  estado       String   @default("activo")
  organizacion String?
  avatar       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organizaciones OrganizacionMember[]
  formularios    Formulario[]
  plantillas     Plantilla[]
  estadisticas   Estadistica[]

  @@map("users")
}

model Organizacion {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  logo        String?
  estado      EstadoOrganizacion @default(ACTIVA)
  direccion   String?
  telefono    String?
  email       String?
  sitioWeb    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  miembros     OrganizacionMember[]
  formularios  Formulario[]
  plantillas   Plantilla[]
  estadisticas Estadistica[]

  @@map("organizaciones")
}

model OrganizacionMember {
  id             String @id @default(cuid())
  userId         String
  organizacionId String
  rol            RolOrganizacion @default(MIEMBRO)
  fechaIngreso   DateTime @default(now())

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizacion Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)

  @@unique([userId, organizacionId])
  @@map("organizacion_members")
}

model Formulario {
  id             String @id @default(cuid())
  titulo         String
  descripcion    String?
  contenido      Json   // Almacena la estructura del formulario
  estado         EstadoFormulario @default(BORRADOR)
  fechaPublicacion DateTime?
  fechaVencimiento DateTime?
  permiteMultiples Boolean @default(true)
  requiereLogin    Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Foreign Keys
  creadorId      String
  organizacionId String?

  // Relations
  creador      User          @relation(fields: [creadorId], references: [id])
  organizacion Organizacion? @relation(fields: [organizacionId], references: [id])
  respuestas   RespuestaFormulario[]
  plantilla    Plantilla?

  @@map("formularios")
}

model RespuestaFormulario {
  id          String   @id @default(cuid())
  formularioId String
  respuestas  Json     // Almacena las respuestas del formulario
  emailContacto String?
  nombreContacto String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  formulario Formulario @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  @@map("respuestas_formulario")
}

model Plantilla {
  id          String @id @default(cuid())
  nombre      String
  descripcion String?
  contenido   Json   // Estructura del formulario template
  categoria   CategoriaPlantilla @default(GENERAL)
  esPublica   Boolean @default(false)
  usoCount    Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  creadorId      String
  organizacionId String?
  formularioId   String? @unique

  // Relations
  creador      User          @relation(fields: [creadorId], references: [id])
  organizacion Organizacion? @relation(fields: [organizacionId], references: [id])
  formulario   Formulario?   @relation(fields: [formularioId], references: [id])

  @@map("plantillas")
}

model Estadistica {
  id       String @id @default(cuid())
  tipo     TipoEstadistica
  valor    Float
  metadatos Json?
  fecha    DateTime @default(now())

  // Foreign Keys
  userId         String?
  organizacionId String?

  // Relations
  user         User?         @relation(fields: [userId], references: [id])
  organizacion Organizacion? @relation(fields: [organizacionId], references: [id])

  @@map("estadisticas")
}

// Nuevos modelos para las funcionalidades adicionales

model Comunidad {
  id                     String   @id @default(cuid())
  fechaInscripcion       String
  departamento           String
  municipio              String
  aldeas                 String
  caseriosAtienden       String[] // Array de strings
  qtyCaserios            Int
  ubicacionGoogleMaps    String?
  lider                  String
  numeroLider            String
  asistenteGrupoLideres  String?
  comiteComunitario      String?
  activa                 Boolean  @default(true)
  cantidadFamilias       Int
  cantidadFamRA          Int
  primeraInfanciaMujeres Int      @default(0)
  primeraInfanciaHombres Int      @default(0)
  ninez3a5Mujeres        Int      @default(0)
  ninez3a5Hombres        Int      @default(0)
  jovenes6a10Mujeres     Int      @default(0)
  jovenes6a10Hombres     Int      @default(0)
  adultos11a18Mujeres    Int      @default(0)
  adultos11a18Hombres    Int      @default(0)
  adultos19a60Mujeres    Int      @default(0)
  adultos19a60Hombres    Int      @default(0)
  adultoMayor61Mujeres   Int      @default(0)
  adultoMayor61Hombres   Int      @default(0)
  mujeresGestantes       Int      @default(0)
  mujeresLactantes       Int      @default(0)
  clasificacion          String
  capacidadAlmacenamiento String?
  formasColocacionInteres String[] // Array de strings
  tipoColocacion         String?
  grupoWhatsapp          String?
  book                   String?
  bolsasMaximo           Int      @default(0)
  bolsasCortesia         Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("comunidades")
}

model FormularioAuditoria {
  id           String               @id @default(cuid())
  nombre       String
  descripcion  String?
  organizacion String
  responsable  String
  campos       Int                  @default(0)
  respuestas   Int                  @default(0)
  estado       EstadoAuditoria      @default(ACTIVO)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@map("formularios_auditoria")
}

model BaseDatos {
  id                  String        @id @default(cuid())
  nombre              String
  descripcion         String?
  tipo                TipoBaseDatos @default(POSTGRESQL)
  tamaño              String
  registros           Int           @default(0)
  estado              EstadoBD      @default(ACTIVA)
  ultimaActualizacion DateTime      @default(now())
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@map("bases_datos")
}

model Beneficiario {
  id            String           @id @default(cuid())
  nombre        String
  apellidos     String
  edad          Int
  genero        Genero
  telefono      String
  direccion     String
  comunidad     String
  fechaIngreso  DateTime
  tipoApoyo     String[]         // Array de strings
  estado        EstadoBeneficiario @default(ACTIVO)
  responsable   String
  observaciones String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@map("beneficiarios")
}

model Voluntario {
  id           String          @id @default(cuid())
  nombre       String
  apellidos    String
  edad         Int
  telefono     String
  email        String?
  direccion    String?
  area         String
  experiencia  String?
  disponibilidad String[]      // Array de strings
  estado       EstadoVoluntario @default(ACTIVO)
  fechaIngreso DateTime
  supervisor   String?
  observaciones String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@map("voluntarios")
}

// Enums
enum Role {
  USER
  ADMIN
  SUPER_ADMIN
  COORDINADOR
  VOLUNTARIO
}

enum EstadoOrganizacion {
  ACTIVA
  INACTIVA
  SUSPENDIDA
}

enum RolOrganizacion {
  ADMIN
  EDITOR
  MIEMBRO
  INVITADO
}

enum EstadoFormulario {
  BORRADOR
  PUBLICADO
  CERRADO
  ARCHIVADO
}

enum CategoriaPlantilla {
  GENERAL
  EDUCACION
  SALUD
  EVENTOS
  ENCUESTAS
  CONTACTO
  FEEDBACK
  OTROS
}

enum TipoEstadistica {
  FORMULARIOS_CREADOS
  RESPUESTAS_RECIBIDAS
  USUARIOS_ACTIVOS
  ORGANIZACIONES_NUEVAS
  PLANTILLAS_UTILIZADAS
  TASA_CONVERSION
  TIEMPO_RESPUESTA
}

enum EstadoAuditoria {
  ACTIVO
  INACTIVO
  REVISION
}

enum TipoBaseDatos {
  MYSQL
  POSTGRESQL
  MONGODB
  EXCEL
}

enum EstadoBD {
  ACTIVA
  INACTIVA
  MANTENIMIENTO
}

enum Genero {
  MASCULINO
  FEMENINO
  OTRO
}

enum EstadoBeneficiario {
  ACTIVO
  INACTIVO
  GRADUADO
}

enum EstadoVoluntario {
  ACTIVO
  INACTIVO
  SUSPENDIDO
}

// Modelos PIMCO
model ComunidadPimco {
  id                      String   @id @default(cuid())
  nombreComunidad         String
  departamento            String
  municipio               String
  aldeas                  String
  caseriosQueAtienden     String
  qtyCaseriosQueAtienden  Int
  ubicacionGoogleMaps     String?
  coordinadorComunitario  String?
  liderNumero             String
  comiteComunitario       String
  activa                  Boolean  @default(true)
  cantidadFamiliasEnComunidad Int
  cantidadFamEnRA         Int
  fotografiaReferencia    String?
  motivoSuspencionOBaja   String?
  fechaCreacion           DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relaciones
  entrevistas             EntrevistaPimco[]

  @@map("comunidades_pimco")
}

model EntrevistaPimco {
  id                      String   @id @default(cuid())
  marcaTemporal           DateTime @default(now())
  fechaEncuesta           DateTime
  estadoVisita            String   // "Primera Visita", "Visita de Seguimiento"
  encargadoVisita         String
  sexoEntrevistado        String   // "Masculino", "Femenino"
  fechaNacimiento         DateTime?
  dpi                     String?
  edad                    Int?
  etnia                   String?  // "Ladino / Mestizo", "Maya", etc.
  escolaridad             String?  // "Primaria", "Básicos", "Preprimaria", etc.
  tipoVivienda            String?  // "Propia", "Alquilada", etc.
  personasHogar           Int?
  ingresoMensual          String?  // "Q.300.00 - Q.500.00", "< Q.300.00", etc.
  personaEmbarazada       Boolean?
  mesesEmbarazo           String?
  personaDiscapacidad     Boolean?
  observacionesDiscapacidad String?
  convulsiones            String?
  
  // Agua y saneamiento
  fuenteAgua              String?  // "Chorro dentro de la vivienda", "Pozo", etc.
  frecuenciaAgua          String?  // "1 a 2 veces a la semana", etc.
  duracionAgua            String?  // "> 7 días", "1 día", etc.
  distanciaAgua           String?  // "2 km", etc.
  tiempoAgua              String?  // "15 min", etc.
  tratamientoAgua         String?  // "SODIS", "Clorado", "Hervido", etc.
  tipoSanitario           String?  // "Inodoro", "Fosa Septica", etc.
  eliminaAguasNegras      Boolean?
  formaEliminacion        String?  // "Al aire libre / calle", "Alcantarillado", etc.
  energiaElectrica        Boolean?
  
  // Materiales de vivienda
  materialParedes         String?  // "Adobe", "Block", "Ladrillo", etc.
  materialTecho           String?  // "Lámina", "Concreto", etc.
  materialPiso            String?  // "Torta de barro", "Tierra", "Piso cerámico", etc.
  materialPatio           String?  // "Torta de barro", "Tierra", "Torta de cemento", etc.
  espaciosVivienda        String?  // "2", "3 o más", etc.
  cocinaSeparada          Boolean?
  observacionesCocina     String?
  
  // Higiene
  habitosHigiene          String?  // "Baño diario, Lavado frecuente de manos, etc."
  frecuenciaHigiene       String?  // "Todos los días", etc.
  
  // Ocupación e ingresos
  ocupacionJefeHogar      String?  // "Actividad Agrícola", "Ama (o) de casa", etc.
  fuenteIngresoFamilia    String?  // "Jornalero", "Ninguna", etc.
  personasTrabajan        Int?
  familiarExtranjero      Boolean?
  recibeRemesas           Boolean?
  frecuenciaRemesas       String?
  usoRemesas              String?
  
  // Agricultura
  tieneTierra             Boolean?
  alquilaTierra           Boolean?
  cultivaTierra           String?  // "Frijol", etc.
  usoCosecha              String?  // "Consumo", "Venta", etc.
  guardaAlimentos         Boolean?
  alimentosGuardados      String?  // "Frijol", etc.
  cantidadAlmacena        String?  // "> 3 quintales", etc.
  tiempoDura              String?  // "> 1 mes", etc.
  huertoFamiliar          Boolean?
  cosechaHuerto           String?
  controlPlagas           Boolean?
  metodosControl          String?
  sistemaRiego            Boolean?
  tipoRiego               String?
  fuenteAguaRiego         String?
  
  // Salud
  accesoSalud             Boolean?
  enfermerosPermanentes   Boolean?
  tiempoSalud             String?  // "1 hora", "15 min", etc.
  ninesMenores5           Int?
  controlVacunacion       Boolean?
  enfermanDiarrea         Boolean?
  frecuenciaDiarrea       String?  // "Cada 2 meses", etc.
  acudeSaludDiarrea       Boolean?
  enfermanRespiratorias   Boolean?
  frecuenciaRespiratorias String?
  acudeSaludRespiratorias Boolean?
  
  // Escala de hambre
  escalaHambre1           String?  // "No ocurrió", "Pocas veces", "Algunas veces", etc.
  escalaHambre2           String?
  escalaHambre3           String?
  tiemposComida           String?  // "Desayuno, Almuerzo, Cena", etc.
  
  // Consumo de alimentos (usando JSON para almacenar estructuras complejas)
  consumoVerduras         Json?    // Datos de verduras y hortalizas
  consumoFrutas           Json?    // Datos de frutas
  consumoAzucares         Json?    // Datos de azúcares
  consumoCereales         Json?    // Datos de cereales y leguminosas
  consumoCarnes           Json?    // Datos de carnes
  consumoLacteos          Json?    // Datos de lácteos y huevos
  consumoGrasas           Json?    // Datos de grasas
  
  // Capacitaciones y otros
  temasCapacitacion       String?  // "Agua Potable y Salud", etc.
  nombreEncargado         String?  // Nombre del encargado de la visita
  precioVenta             String?  // Para productos que se venden
  
  comunidadId             String
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relaciones
  comunidad               ComunidadPimco @relation(fields: [comunidadId], references: [id], onDelete: Cascade)

  @@map("entrevistas_pimco")
}

model EncuestadorPimco {
  id                      String   @id @default(cuid())
  nombre                  String
  apellidos               String
  telefono                String?
  email                   String?
  activo                  Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("encuestadores_pimco")
}

enum TipoVisita {
  PRIMERA_VISITA
  VISITA_SEGUIMIENTO
  SEGUIMIENTO_ADICIONAL
}
